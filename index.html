<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Referral Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body{font-family: sans-serif; padding:20px;}
    .card{border:1px solid #eee;padding:18px;border-radius:8px;max-width:600px;margin:auto}
    button{padding:10px 14px;margin:6px;border-radius:6px;border:0;background:#1e88e5;color:#fff}
  </style>
</head>
<body>
  <div class="card">
    <h2>Refer & Earn</h2>
    <p id="welcome">Loading...</p>

    <div>
      <label>আপনার রেফার লিংক (Copy / Share):</label>
      <div style="margin-top:8px">
        <input id="refLink" style="width:100%;padding:8px" readonly />
      </div>

      <div style="margin-top:10px">
        <button id="copyBtn">Copy Referral Link</button>
        <button id="shareBtn">Share Now</button>
      </div>
    </div>

    <hr/>
    <div>
      <p>Partnered with Bot: <strong>@ttamo_bot</strong></p>
      <p>Balance: <span id="balance">0</span> টাকা</p>
    </div>
  </div>

<script>
  // ========== Firebase config (user provided) ==========
  const firebaseConfig = {
    apiKey: "AIzaSyB2UyrZZ5yu9N4EJLELXBkcLRYe6OA4IJM",
    authDomain: "tta-mo.firebaseapp.com",
    projectId: "tta-mo",
    storageBucket: "tta-mo.firebasestorage.app",
    messagingSenderId: "768846766181",
    appId: "1:768846766181:web:a2c2af74b6e3c087b4268c"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const tg = window.Telegram.WebApp;
  tg.ready();

  // get user info (if opened inside Telegram webapp)
  const user = tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
  // fallback: if opened as normal webpage, user will be null
  const referrerId = (user && user.id) ? String(user.id) : null;

  async function setup() {
    const elWelcome = document.getElementById('welcome');
    const refInput = document.getElementById('refLink');
    const balanceEl = document.getElementById('balance');

    let myId = referrerId;
    if (!myId) {
      // If not inside Telegram WebApp, ask for a manual id (developer/testing)
      elWelcome.innerText = "WebApp এ চালালে স্বয়ংক্রিয়ভাবে আপনার আইডি ধরবে।";
      // for testing you can put your telegram id here:
      // myId = "7109891636";
    } else {
      elWelcome.innerText = `স্বাগতম, ${user.first_name || ''} (${myId})`;
    }

    // Referral link format: open bot's mini app directly with startapp param
    // Use: https://t.me/ttamo_bot/app?startapp=<referrerId>
    const botUsername = "ttamo_bot";
    const link = myId ? `https://t.me/${botUsername}/app?startapp=${myId}` : `https://t.me/${botUsername}/app`;
    refInput.value = link;

    // fetch balance from firestore (if exists)
    if (myId) {
      const doc = await db.collection('users').doc(myId).get();
      if (doc.exists) {
        const data = doc.data();
        balanceEl.innerText = data.balance || 0;
      } else {
        balanceEl.innerText = 0;
      }
    }

    document.getElementById('copyBtn').onclick = () => {
      navigator.clipboard.writeText(refInput.value).then(()=> alert('Copied!'));
    };

    document.getElementById('shareBtn').onclick = () => {
      if (navigator.share) {
        navigator.share({ title: 'Join via my link', text: 'Join this bot & earn', url: refInput.value });
      } else {
        navigator.clipboard.writeText(refInput.value).then(()=> alert('Link copied. Paste to share.'));
      }
    };
  }

  setup();
</script>
</body>
</html>
